#!/bin/bash
set -e

# Set our DNS requirements
TTL=300
id=$(cut -d/ -f2 <<< $JUJU_UNIT_NAME)
ip=$($CHARM_DIR/lib/unit-get public-address)
relation-set domain=$(config-get zone)
relation-set resources='ellis '$TTL' IN A '$ip'
ellis-'$id' '$TTL' IN A '$ip

# Update our DNS server
if [ "$(relation-get public-address)" != "" ]
then
  echo nameserver $(relation-get public-address) > /etc/dnsmasq.resolv.conf
  grep -v ^RESOLV_CONF= /etc/default/dnsmasq > /tmp/dnsmasq.$$ || juju-log "WARNING RESOLV_CONF not found"
  mv /tmp/dnsmasq.$$ /etc/default/dnsmasq
  echo RESOLV_CONF=/etc/dnsmasq.resolv.conf >> /etc/default/dnsmasq
  service dnsmasq restart
fi

# Update Clearwater configuration and restart
$CHARM_DIR/lib/config_script programmable-multiple
$CHARM_DIR/lib/restart
